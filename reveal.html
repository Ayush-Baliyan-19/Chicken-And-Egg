<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>And the answer is...</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./yes_style.css">
</head>
<body>
    <div id="countdown" class="countdown"><span class="countdown-num">1</span><span class="countdown-dots">...</span></div>

    <div class="curtain curtain-left" id="curtainLeft"></div>
    <div class="curtain curtain-right" id="curtainRight"></div>

    <div id="confetti" class="confetti" aria-hidden="true"></div>

    <!-- Floating birthday decorations -->
    <div class="floating-decor">
        <span class="decor-item decor-1">üéà</span>
        <span class="decor-item decor-2">üéâ</span>
        <span class="decor-item decor-3">‚ú®</span>
        <span class="decor-item decor-4">üéÇ</span>
        <span class="decor-item decor-5">üéà</span>
        <span class="decor-item decor-6">‚≠ê</span>
    </div>

    <!-- Tap to unmute overlay for Safari -->
    <div id="unmuteOverlay" class="unmute-overlay" style="display: none;">
        <button type="button" class="unmute-btn">üîä Tap for sound</button>
    </div>

    <section id="section-video1" class="section">
        <div class="stage">
            <div class="reveal-content">
                <h1 class="reveal-title">You came first!</h1>
                <p class="reveal-subtitle">Happy Birthday!</p>
                <div class="video-container">
                    <video id="mainVideo" playsinline webkit-playsinline muted controls>
                        <source src="./BhaiKaBdday.mp4" type="video/mp4">
                    </video>
                </div>
                <button type="button" class="continue-btn" id="btnContinue" onclick="goToNext()">Wait there is more</button>
            </div>
        </div>
    </section>

    <style>
        .unmute-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .unmute-btn {
            background: linear-gradient(135deg, #e8c547 0%, #f5d76e 50%, #e8c547 100%);
            color: #1a1a2e;
            border: none;
            padding: 20px 40px;
            font-size: 1.5rem;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(232, 197, 71, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Floating birthday decorations */
        .floating-decor {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 4;
            overflow: hidden;
        }

        .decor-item {
            position: absolute;
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            opacity: 0.4;
            animation: floatDecor 6s ease-in-out infinite;
        }

        .decor-1 { top: 12%; left: 8%; animation-delay: 0s; }
        .decor-2 { top: 20%; right: 10%; animation-delay: 1s; }
        .decor-3 { top: 45%; left: 5%; animation-delay: 2s; }
        .decor-4 { bottom: 25%; right: 8%; animation-delay: 3s; }
        .decor-5 { bottom: 15%; left: 12%; animation-delay: 4s; }
        .decor-6 { top: 65%; right: 6%; animation-delay: 5s; }

        @keyframes floatDecor {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(10deg); }
        }
    </style>

    <script>
        (function () {
            var countdownEl = document.getElementById('countdown');
            var curtainLeft = document.getElementById('curtainLeft');
            var curtainRight = document.getElementById('curtainRight');
            var confettiEl = document.getElementById('confetti');
            var mainVideo = document.getElementById('mainVideo');
            var btnContinue = document.getElementById('btnContinue');
            var unmuteOverlay = document.getElementById('unmuteOverlay');

            var steps = ['1', '2', '3'];
            var step = 0;
            var videoStarted = false;

            function burstConfetti() {
                var colors = ['#f9e076', '#e8c547', '#c9a227', '#ff9f43', '#ff6b6b', '#a29bfe', '#55efc4', '#fd79a8'];
                var count = 60;
                for (var i = 0; i < count; i++) {
                    var c = document.createElement('div');
                    c.className = 'confetti-piece';
                    c.style.left = Math.random() * 100 + '%';
                    c.style.animationDelay = Math.random() * 0.5 + 's';
                    c.style.animationDuration = (2 + Math.random() * 2) + 's';
                    c.style.background = colors[Math.floor(Math.random() * colors.length)];
                    c.style.transform = 'rotate(' + (Math.random() * 360) + 'deg)';
                    confettiEl.appendChild(c);
                    setTimeout(function (el) {
                        if (el.parentNode) el.parentNode.removeChild(el);
                    }, 4000 + Math.random() * 1000, c);
                }
            }

            function playVideo() {
                if (!mainVideo || videoStarted) return;

                mainVideo.muted = true;
                mainVideo.play().then(function() {
                    videoStarted = true;

                    // Try to unmute
                    setTimeout(function() {
                        mainVideo.muted = false;
                        // Check if unmute worked
                        setTimeout(function() {
                            if (mainVideo.muted && unmuteOverlay) {
                                unmuteOverlay.style.display = 'flex';
                            }
                        }, 100);
                    }, 100);
                }).catch(function() {});
            }

            function showNextCountdown() {
                if (step < steps.length) {
                    var numSpan = countdownEl ? countdownEl.querySelector('.countdown-num') : null;
                    if (numSpan) numSpan.textContent = steps[step];
                    if (countdownEl) countdownEl.classList.remove('countdown-hide');
                    step++;
                    setTimeout(showNextCountdown, 1000);
                } else {
                    if (countdownEl) countdownEl.classList.add('countdown-hide');
                    setTimeout(openCurtain, 400);
                }
            }

            function openCurtain() {
                if (curtainLeft) curtainLeft.classList.add('curtain-open');
                if (curtainRight) curtainRight.classList.add('curtain-open');
                burstConfetti();
                document.getElementById('section-video1').classList.add('section-active');
                playVideo();
            }

            // Handle unmute overlay click
            if (unmuteOverlay) {
                unmuteOverlay.addEventListener('click', function() {
                    if (mainVideo) {
                        mainVideo.muted = false;
                    }
                    unmuteOverlay.style.display = 'none';
                });
            }

            setTimeout(showNextCountdown, 300);

            if (mainVideo) {
                mainVideo.addEventListener('ended', function () {
                    if (btnContinue) btnContinue.classList.add('continue-btn-visible');

                    // Start background music after video ends
                    var bgMusic = document.getElementById('bgMusic');
                    var btnMusicToggle = document.getElementById('btnMusicToggle');
                    if (bgMusic) {
                        bgMusic.volume = 0.4;
                        bgMusic.currentTime = 0;
                        localStorage.setItem('bgMusicTime', '0');
                        localStorage.setItem('bgMusicMuted', 'false');
                        bgMusic.play().catch(function () {});

                        // Save music position periodically
                        setInterval(function() {
                            if (!bgMusic.paused) {
                                localStorage.setItem('bgMusicTime', bgMusic.currentTime);
                            }
                        }, 500);
                    }

                    // Show music toggle button
                    if (btnMusicToggle) {
                        btnMusicToggle.style.display = 'flex';
                        btnMusicToggle.addEventListener('click', function () {
                            if (bgMusic.paused) {
                                bgMusic.play().catch(function () {});
                                btnMusicToggle.textContent = 'üîä';
                                btnMusicToggle.classList.remove('muted');
                                localStorage.setItem('bgMusicMuted', 'false');
                            } else {
                                bgMusic.pause();
                                btnMusicToggle.textContent = 'üîá';
                                btnMusicToggle.classList.add('muted');
                                localStorage.setItem('bgMusicMuted', 'true');
                            }
                        });
                    }
                });
            }

            // Save position before leaving page
            window.addEventListener('beforeunload', function() {
                var bgMusic = document.getElementById('bgMusic');
                if (bgMusic) {
                    localStorage.setItem('bgMusicTime', bgMusic.currentTime);
                    localStorage.setItem('bgMusicMuted', bgMusic.paused);
                }
            });
        })();

        function preloadAssets(assets) {
            var promises = assets.map(function(asset) {
                return new Promise(function(resolve) {
                    if (asset.type === 'image') {
                        var img = new Image();
                        img.onload = resolve;
                        img.onerror = resolve;
                        img.src = asset.src;
                    } else if (asset.type === 'audio') {
                        var audio = new Audio();
                        audio.preload = 'auto';
                        audio.oncanplaythrough = resolve;
                        audio.onerror = resolve;
                        audio.src = asset.src;
                        audio.load();
                        setTimeout(resolve, 3000);
                    } else {
                        resolve();
                    }
                });
            });
            return Promise.all(promises);
        }

        function goToNext() {
            var btn = document.getElementById('btnContinue');
            if (btn) {
                btn.textContent = 'Loading...';
                btn.disabled = true;
            }

            // Preload assets for balloons.html
            var assets = [
                { type: 'image', src: './assets/balloon.png' },
                { type: 'image', src: './assets/balloon-popped.png' },
                { type: 'audio', src: './pop.mp3' }
            ];

            preloadAssets(assets).then(function() {
                window.location.href = 'balloons.html';
            });
        }
    </script>

    <audio id="bgMusic" loop>
        <source src="./assets/bg-music.webm" type="audio/webm">
    </audio>
    <button type="button" class="music-toggle" id="btnMusicToggle" style="display: none;" title="Toggle music" aria-label="Toggle background music">üîä</button>
</body>
</html>
