<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Special Message</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./yes_style.css">
</head>
<body>
    <section id="section-video2" class="section section-active">
        <div class="section-inner section-video2-inner">
            <div class="video-container">
                <video id="video2" playsinline>
                    <source src="./HappyBirthdayVishu.mp4" type="video/mp4">
                </video>
            </div>
            <button type="button" class="continue-btn section-video2-continue" id="btnContinue" onclick="goToNext()">And Finally</button>
        </div>
    </section>

    <audio id="bgMusic" loop>
        <source src="./assets/bg-music.webm" type="audio/webm">
    </audio>
    <button type="button" class="music-toggle" id="btnMusicToggle" title="Toggle music" aria-label="Toggle background music">ðŸ”Š</button>

    <script>
        (function () {
            var video2 = document.getElementById('video2');
            var btnContinue = document.getElementById('btnContinue');
            var bgMusic = document.getElementById('bgMusic');
            var btnMusicToggle = document.getElementById('btnMusicToggle');

            // Restore music position from localStorage but keep it paused during video
            var savedTime = parseFloat(localStorage.getItem('bgMusicTime')) || 0;
            var wasMuted = localStorage.getItem('bgMusicMuted') === 'true';

            bgMusic.volume = 0.4;
            bgMusic.currentTime = savedTime;

            // Music stays paused during video - toggle button hidden initially
            btnMusicToggle.style.display = 'none';

            // Auto-play video
            if (video2) {
                video2.playbackRate = 1;
                video2.muted = false;
                video2.play().catch(function () {});

                // Show continue button and start music when video ends
                video2.addEventListener('ended', function() {
                    if (btnContinue) btnContinue.classList.add('continue-btn-visible');

                    // Start background music after video ends
                    if (!wasMuted) {
                        bgMusic.play().catch(function () {});
                        btnMusicToggle.style.display = 'flex';
                    } else {
                        btnMusicToggle.textContent = 'ðŸ”‡';
                        btnMusicToggle.classList.add('muted');
                        btnMusicToggle.style.display = 'flex';
                    }

                    // Save music position periodically
                    setInterval(function() {
                        if (!bgMusic.paused) {
                            localStorage.setItem('bgMusicTime', bgMusic.currentTime);
                        }
                    }, 500);
                });
            }

            // Music toggle handler
            btnMusicToggle.addEventListener('click', function () {
                if (bgMusic.paused) {
                    bgMusic.play().catch(function () {});
                    btnMusicToggle.textContent = 'ðŸ”Š';
                    btnMusicToggle.classList.remove('muted');
                    localStorage.setItem('bgMusicMuted', 'false');
                } else {
                    bgMusic.pause();
                    btnMusicToggle.textContent = 'ðŸ”‡';
                    btnMusicToggle.classList.add('muted');
                    localStorage.setItem('bgMusicMuted', 'true');
                }
            });

            // Save position before leaving page
            window.addEventListener('beforeunload', function() {
                localStorage.setItem('bgMusicTime', bgMusic.currentTime);
                localStorage.setItem('bgMusicMuted', bgMusic.paused);
            });
        })();

        function preloadAssets(assets) {
            var promises = assets.map(function(asset) {
                return new Promise(function(resolve) {
                    if (asset.type === 'image') {
                        var img = new Image();
                        img.onload = resolve;
                        img.onerror = resolve;
                        img.src = asset.src;
                    } else {
                        resolve();
                    }
                });
            });
            return Promise.all(promises);
        }

        function goToNext() {
            var btn = document.getElementById('btnContinue');
            if (btn) {
                btn.textContent = 'Loading...';
                btn.disabled = true;
            }

            // Preload assets for envelope.html
            var assets = [
                { type: 'image', src: './assets/envelope-closed.png' },
                { type: 'image', src: './assets/envelope-open.png' },
                { type: 'image', src: './assets/flowers.png' }
            ];

            preloadAssets(assets).then(function() {
                window.location.href = 'envelope.html';
            });
        }
    </script>
</body>
</html>
